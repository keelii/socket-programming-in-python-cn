# å®¢æˆ·ç«¯/æœåŠ¡å™¨åº”ç”¨ç¨‹åº

å¤šè¿æ¥çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç¨‹åºç‰ˆæœ¬ä¸æœ€æ—©çš„åŸå§‹ç‰ˆæœ¬ç›¸æ¯”è‚¯å®šæœ‰äº†å¾ˆå¤§çš„æ”¹å–„ï¼Œä½†æ˜¯è®©æˆ‘ä»¬å†è¿›ä¸€æ­¥åœ°è§£å†³ä¸Šé¢ã€Œå¤šè¿æ¥ã€ç‰ˆæœ¬ä¸­çš„ä¸è¶³ï¼Œç„¶åå®Œæˆæœ€ç»ˆç‰ˆçš„å®ç°ï¼šå®¢æˆ·ç«¯/æœåŠ¡å™¨åº”ç”¨ç¨‹åº

æˆ‘ä»¬å¸Œæœ›æœ‰ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åœ¨ä¸å½±å“å…¶å®ƒè¿æ¥çš„æƒ…å†µä¸‹åšå¥½é”™è¯¯å¤„ç†ï¼Œæ˜¾ç„¶ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œæˆ‘ä»¬çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸èƒ½å´©æºƒçš„ä¸€å›¢ç³Ÿã€‚è¿™ä¹Ÿæ˜¯åˆ°ç°åœ¨ä¸ºæ­¢æˆ‘ä»¬è¿˜æ²¡è®¨è®ºçš„ä¸œè¥¿ï¼Œæˆ‘æ•…æ„æ²¡æœ‰å¼•å…¥é”™è¯¯å¤„ç†æœºåˆ¶å› ä¸ºè¿™æ ·å¯ä»¥ä½¿ä¹‹å‰çš„ç¨‹åºå®¹æ˜“ç†è§£

ç°åœ¨ä½ å¯¹åŸºæœ¬çš„ APIï¼Œéé˜»å¡ socketã€select() ç­‰æ¦‚å¿µå·²ç»æœ‰æ‰€äº†è§£äº†ã€‚æˆ‘ä»¬å¯ä»¥ç»§ç»­æ·»åŠ ä¸€äº›é”™è¯¯å¤„ç†åŒæ—¶è®¨è®ºä¸‹ã€Œ[æˆ¿é—´é‡Œé¢çš„å¤§è±¡](https://zh.wikipedia.org/wiki/%E6%88%BF%E9%96%93%E8%A3%8F%E7%9A%84%E5%A4%A7%E8%B1%A1)ã€çš„é—®é¢˜ï¼Œæˆ‘æŠŠä¸€äº›ä¸œè¥¿éšè—åœ¨äº†å¹•åã€‚ä½ åº”è¯¥è¿˜è®°å¾—ï¼Œæˆ‘åœ¨ä»‹ç»ä¸­è®¨è®ºåˆ°çš„è‡ªå®šä¹‰ç±»

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å…ˆè§£å†³é”™è¯¯ï¼š

> æ‰€æœ‰çš„é”™è¯¯éƒ½ä¼šè§¦å‘å¼‚å¸¸ï¼Œåƒæ— æ•ˆå‚æ•°ç±»å‹å’Œå†…å­˜ä¸è¶³çš„å¸¸è§å¼‚å¸¸å¯ä»¥è¢«æŠ›å‡ºï¼›ä» Python 3.3 å¼€å§‹ï¼Œä¸ socket æˆ–åœ°å€è¯­ä¹‰ç›¸å…³çš„é”™è¯¯ä¼šå¼•å‘ OSError æˆ–å…¶å­ç±»ä¹‹ä¸€çš„å¼‚å¸¸ [å¼•ç”¨](https://docs.python.org/3/library/socket.html)

æˆ‘ä»¬éœ€è¦æ•è· `OSError` å¼‚å¸¸ã€‚å¦å¤–ä¸€ä¸ªæˆ‘æ²¡æåŠçš„çš„é—®é¢˜æ˜¯å»¶è¿Ÿï¼Œä½ å°†åœ¨æ–‡æ¡£çš„å¾ˆå¤šåœ°æ–¹çœ‹è§å…³äºå»¶è¿Ÿçš„è®¨è®ºï¼Œå»¶è¿Ÿä¼šå‘ç”Ÿè€Œä¸”å±äºã€Œæ­£å¸¸ã€é”™è¯¯ã€‚ä¸»æœºæˆ–è€…è·¯ç”±å™¨é‡å¯ã€äº¤æ¢æœºç«¯å£å‡ºé”™ã€ç”µç¼†å‡ºé—®é¢˜æˆ–è€…è¢«æ‹”å‡ºï¼Œä½ åº”è¯¥åœ¨ä½ çš„ä»£ç ä¸­å¤„ç†å¥½å„ç§å„æ ·çš„é”™è¯¯

åˆšæ‰è¯´çš„ã€Œæˆ¿é—´é‡Œé¢çš„å¤§è±¡ã€é—®é¢˜æ˜¯æ€ä¹ˆå›äº‹å‘¢ã€‚å°±åƒ `socket.SOCK_STREAM` è¿™ä¸ªå‚æ•°çš„å­—é¢æ„æ€ä¸€æ ·ï¼Œå½“ä½¿ç”¨ TCP è¿æ¥æ—¶ï¼Œä½ ä¼šä»ä¸€ä¸ªè¿ç»­çš„å­—èŠ‚æµè¯»å–çš„æ•°æ®ï¼Œå¥½æ¯”ä»ç£ç›˜ä¸Šè¯»å–æ•°æ®ï¼Œä¸åŒçš„æ˜¯ä½ æ˜¯ä»ç½‘ç»œè¯»å–å­—èŠ‚æµ

ç„¶è€Œï¼Œå’Œä½¿ç”¨ `f.seek()` è¯»æ–‡ä»¶ä¸åŒï¼Œæ¢å¥è¯è¯´ï¼Œæ²¡æ³•å®šä½ socket çš„æ•°æ®æµçš„ä½ç½®ï¼Œå¦‚æœå¯ä»¥åƒæ–‡ä»¶ä¸€æ ·å®šä½æ•°æ®æµçš„ä½ç½®ï¼ˆä½¿ç”¨ä¸‹æ ‡ï¼‰ï¼Œé‚£ä½ å°±å¯ä»¥éšæ„çš„è¯»å–ä½ æƒ³è¦çš„æ•°æ®

å½“å­—èŠ‚æµå…¥ä½ çš„ socket æ—¶ï¼Œä¼šéœ€è¦æœ‰ä¸åŒçš„ç½‘ç»œç¼“å†²åŒºï¼Œå¦‚æœæƒ³è¯»å–ä»–ä»¬å°±å¿…é¡»å…ˆä¿å­˜åˆ°å…¶å®ƒåœ°æ–¹ï¼Œä½¿ç”¨ `recv()` æ–¹æ³•æŒç»­çš„ä» socket ä¸Šè¯»å–å¯ç”¨çš„å­—èŠ‚æµ

ç›¸å½“äºä½ ä» socket ä¸­è¯»å–çš„æ˜¯ä¸€å—ä¸€å—çš„æ•°æ®ï¼Œä½ å¿…é¡»ä½¿ç”¨ `recv()` æ–¹æ³•ä¸æ–­çš„ä»ç¼“å†²åŒºä¸­è¯»å–æ•°æ®ï¼Œç›´åˆ°ä½ çš„åº”ç”¨ç¡®å®šè¯»å–åˆ°äº†è¶³å¤Ÿçš„æ•°æ®

ä»€ä¹ˆæ—¶å€™ç®—ã€Œè¶³å¤Ÿã€è¿™å–å†³äºä½ çš„å®šä¹‰ï¼Œå°± TCP socket è€Œè¨€ï¼Œå®ƒåªé€šè¿‡ç½‘ç»œå‘é€æˆ–æ¥æ”¶åŸå§‹å­—èŠ‚ã€‚å®ƒå¹¶ä¸äº†è§£è¿™äº›åŸå§‹å­—èŠ‚çš„å«ä¹‰

è¿™å¯ä»¥è®©æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåº”ç”¨å±‚åè®®ï¼Œä»€ä¹ˆæ˜¯åº”ç”¨å±‚åè®®ï¼Ÿç®€å•æ¥è¯´ï¼Œä½ çš„åº”ç”¨ä¼šå‘é€æˆ–è€…æ¥æ”¶æ¶ˆæ¯ï¼Œè¿™äº›æ¶ˆæ¯å…¶å®å°±æ˜¯ä½ çš„åº”ç”¨ç¨‹åºçš„åè®®

æ¢å¥è¯è¯´ï¼Œè¿™äº›æ¶ˆæ¯çš„é•¿åº¦ã€æ ¼å¼å¯ä»¥å®šä¹‰åº”ç”¨ç¨‹åºçš„è¯­ä¹‰å’Œè¡Œä¸ºï¼Œè¿™å’Œæˆ‘ä»¬ä¹‹å‰è¯´çš„ä»socket ä¸­è¯»å–å­—èŠ‚éƒ¨åˆ†å†…å®¹ç›¸å…³ï¼Œå½“ä½ ä½¿ç”¨ `recv()` æ¥è¯»å–å­—èŠ‚çš„æ—¶å€™ï¼Œä½ éœ€è¦çŸ¥é“è¯»çš„å­—èŠ‚æ•°ï¼Œå¹¶ä¸”å†³å®šä»€ä¹ˆæ—¶å€™ç®—è¯»å–å®Œæˆ

è¿™äº›éƒ½æ˜¯æ€ä¹ˆå®Œæˆçš„å‘¢ï¼Ÿä¸€ä¸ªæ–¹æ³•æ˜¯åªè¯»å–å›ºå®šé•¿åº¦çš„æ¶ˆæ¯ï¼Œå¦‚æœå®ƒä»¬çš„é•¿åº¦æ€»æ˜¯ä¸€æ ·çš„è¯ï¼Œè¿™æ ·åšå¾ˆå®¹æ˜“ã€‚å½“ä½ æ”¶åˆ°å›ºå®šé•¿åº¦å­—èŠ‚æ¶ˆæ¯çš„æ—¶å€™ï¼Œå°±èƒ½ç¡®å®šå®ƒæ˜¯ä¸ªå®Œæ•´çš„æ¶ˆæ¯

ç„¶è€Œï¼Œå¦‚æœä½ ä½¿ç”¨å®šé•¿æ¨¡å¼æ¥å‘é€æ¯”è¾ƒçŸ­çš„æ¶ˆæ¯ä¼šæ¯”è¾ƒä½æ•ˆï¼Œå› ä¸ºä½ è¿˜å¾—å¤„ç†å¡«å……å‰©ä½™çš„éƒ¨åˆ†ï¼Œæ­¤å¤–ï¼Œä½ è¿˜å¾—å¤„ç†æ•°æ®ä¸é€‚åˆæ”¾åœ¨ä¸€ä¸ªå®šé•¿æ¶ˆæ¯é‡Œé¢çš„æƒ…å†µ

åœ¨è¿™ä¸ªæ•™ç¨‹é‡Œé¢ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªé€šç”¨çš„æ–¹æ¡ˆï¼Œå¾ˆå¤šåè®®éƒ½ä¼šç”¨åˆ°å®ƒï¼ŒåŒ…æ‹¬ HTTPã€‚æˆ‘ä»¬å°†åœ¨æ¯æ¡æ¶ˆæ¯å‰é¢è¿½åŠ ä¸€ä¸ªå¤´ä¿¡æ¯ï¼Œå¤´ä¿¡æ¯ä¸­åŒ…æ‹¬æ¶ˆæ¯çš„é•¿åº¦å’Œå…¶å®ƒæˆ‘ä»¬éœ€è¦çš„å­—æ®µã€‚è¿™æ ·åšçš„è¯æˆ‘ä»¬åªéœ€è¦è¿½è¸ªå¤´ä¿¡æ¯ï¼Œå½“æˆ‘ä»¬è¯»åˆ°å¤´ä¿¡æ¯æ—¶ï¼Œå°±å¯ä»¥æŸ¥åˆ°æ¶ˆæ¯çš„é•¿åº¦å¹¶ä¸”è¯»å‡ºæ‰€æœ‰å­—èŠ‚ç„¶åæ¶ˆè´¹å®ƒ

æˆ‘ä»¬å°†é€šè¿‡ä½¿ç”¨ä¸€ä¸ªè‡ªå®šä¹‰ç±»æ¥å®ç°æ¥æ”¶æ–‡æœ¬/äºŒè¿›åˆ¶æ•°æ®ã€‚ä½ å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šåšå‡ºæ”¹è¿›æˆ–è€…é€šè¿‡ç»§æ‰¿è¿™ä¸ªç±»æ¥æ‰©å±•ä½ çš„åº”ç”¨ç¨‹åºã€‚é‡è¦çš„æ˜¯ä½ å°†çœ‹åˆ°ä¸€ä¸ªä¾‹å­å®ç°å®ƒçš„è¿‡ç¨‹

æˆ‘å°†ä¼šæåˆ°ä¸€äº›å…³äº socket å’Œå­—èŠ‚ç›¸å…³çš„ä¸œè¥¿ï¼Œå°±åƒä¹‹å‰è®¨è®ºè¿‡çš„ã€‚å½“ä½ é€šè¿‡ socket æ¥å‘é€æˆ–è€…æ¥æ”¶æ•°æ®æ—¶ï¼Œå…¶å®ä½ å‘é€æˆ–è€…æ¥æ”¶åˆ°çš„æ˜¯åŸå§‹å­—èŠ‚

å¦‚æœä½ æ”¶åˆ°æ•°æ®å¹¶ä¸”æƒ³è®©å®ƒåœ¨ä¸€ä¸ªå¤šå­—èŠ‚è§£é‡Šçš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ï¼Œæ¯”å¦‚è¯´ 4-byte çš„æ•´å½¢ï¼Œä½ éœ€è¦è€ƒè™‘å®ƒå¯èƒ½æ˜¯ä¸€ç§ä¸æ˜¯ä½ æœºå™¨ CPU æœ¬æœºçš„æ ¼å¼ã€‚å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨çš„å¦å¤–ä¸€å¤´å¯èƒ½æ˜¯å¦å¤–ä¸€ç§ä½¿ç”¨äº†ä¸åŒçš„å­—èŠ‚åºåˆ—çš„ CPUï¼Œè¿™æ ·çš„è¯ï¼Œä½ å°±å¾—æŠŠå®ƒä»¬è½¬æ¢æˆä½ ä¸»æœºçš„æœ¬åœ°å­—èŠ‚åºåˆ—æ¥ä½¿ç”¨

ä¸Šé¢æ‰€è¯´çš„å­—èŠ‚é¡ºåºå°±æ˜¯ CPU çš„ [å­—èŠ‚åº](https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82%E5%BA%8F)ï¼Œåœ¨å¼•ç”¨éƒ¨åˆ†çš„å­—èŠ‚åº ä¸€èŠ‚å¯ä»¥æŸ¥çœ‹æ›´å¤šã€‚æˆ‘ä»¬å°†ä¼šåˆ©ç”¨ Unicode å­—ç¬¦é›†çš„ä¼˜ç‚¹æ¥è§„é¿è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ä½¿ç”¨UTF-8 çš„æ–¹å¼ç¼–ç ï¼Œç”±äº UTF-8 ä½¿ç”¨äº† 8å­—èŠ‚ ç¼–ç æ–¹å¼ï¼Œæ‰€ä»¥å°±ä¸ä¼šæœ‰å­—èŠ‚åºåˆ—çš„é—®é¢˜

ä½ å¯ä»¥æŸ¥çœ‹ Python å…³äºç¼–ç ä¸ Unicode çš„ [æ–‡æ¡£](https://docs.python.org/3/library/codecs.html#encodings-and-unicode)ï¼Œæ³¨æ„æˆ‘ä»¬åªä¼šç¼–ç æ¶ˆæ¯çš„å¤´éƒ¨ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ä¸¥æ ¼çš„ç±»å‹ï¼Œå‘é€çš„æ¶ˆæ¯ç¼–ç æ ¼å¼ä¼šåœ¨å¤´ä¿¡æ¯ä¸­å®šä¹‰ã€‚è¿™å°†è®©æˆ‘ä»¬å¯ä»¥ä¼ è¾“æˆ‘ä»¬è§‰å¾—æœ‰ç”¨çš„ä»»æ„ç±»å‹/æ ¼å¼æ•°æ®

ä½ å¯ä»¥é€šè¿‡è°ƒç”¨ `sys.byteorder` æ¥å†³å®šä½ çš„æœºå™¨çš„å­—èŠ‚åºåˆ—ï¼Œæ¯”å¦‚åœ¨æˆ‘çš„è‹±ç‰¹å°”ç¬”è®°æœ¬ä¸Šï¼Œè¿è¡Œä¸‹é¢çš„ä»£ç å°±å¯ä»¥ï¼š

```bash
$ python3 -c 'import sys; print(repr(sys.byteorder))'
'little'
```

å¦‚æœæˆ‘æŠŠè¿™æ®µä»£ç è·‘åœ¨å¯ä»¥æ¨¡æ‹Ÿå¤§å­—èŠ‚åº CPUã€ŒPowerPCã€çš„è™šæ‹Ÿæœºä¸Šçš„è¯ï¼Œåº”è¯¥æ˜¯ä¸‹é¢çš„ç»“æœï¼š

```bash
$ python3 -c 'import sys; print(repr(sys.byteorder))'
'big'
```

åœ¨æˆ‘ä»¬çš„ä¾‹å­ç¨‹åºä¸­ï¼Œåº”ç”¨å±‚çš„åè®®å®šä¹‰äº†ä½¿ç”¨ UTF-8 æ–¹å¼ç¼–ç çš„ Unicode å­—ç¬¦ã€‚å¯¹äºçœŸæ­£ä¼ è¾“æ¶ˆæ¯æ¥è¯´ï¼Œå¦‚æœéœ€è¦çš„è¯ä½ è¿˜æ˜¯å¾—æ‰‹åŠ¨äº¤æ¢å­—èŠ‚åºåˆ—

è¿™å–å†³äºä½ çš„åº”ç”¨ï¼Œæ˜¯å¦éœ€è¦å®ƒæ¥å¤„ç†ä¸åŒç»ˆç«¯é—´çš„å¤šå­—èŠ‚äºŒè¿›åˆ¶æ•°æ®ï¼Œä½ å¯ä»¥é€šè¿‡æ·»åŠ é¢å¤–çš„å¤´ä¿¡æ¯æ¥è®©ä½ çš„å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡ç«¯æ”¯æŒäºŒè¿›åˆ¶ï¼Œåƒ HTTP ä¸€æ ·ï¼ŒæŠŠå¤´ä¿¡æ¯åšä¸ºå‚æ•°ä¼ è¿›å»

ä¸ç”¨æ‹…å¿ƒè‡ªå·±è¿˜æ²¡ææ‡‚ä¸Šé¢çš„ä¸œè¥¿ï¼Œä¸‹é¢ä¸€èŠ‚æˆ‘ä»¬çœ‹åˆ°æ˜¯å¦‚æœå®ç°çš„

## åº”ç”¨çš„åè®®å¤´

è®©æˆ‘ä»¬æ¥å®šä¹‰ä¸€ä¸ªå®Œæ•´çš„åè®®å¤´ï¼š

* å¯å˜é•¿åº¦çš„æ–‡æœ¬
* åŸºäº UTF-8 ç¼–ç çš„ Unicode å­—ç¬¦é›†
* ä½¿ç”¨ JSON åºåˆ—åŒ–çš„ä¸€ä¸ª Python å­—å…¸

å…¶ä¸­å¿…é¡»å…·æœ‰çš„å¤´åº”è¯¥æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

åç§°             | æè¿°
:--              | :--
byteorder        | æœºå™¨çš„å­—èŠ‚åºåˆ—ï¼ˆuses sys.byteorderï¼‰ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ç”¨ä¸ä¸Š
content-length   | å†…å®¹çš„å­—èŠ‚é•¿åº¦
content-type     | å†…å®¹çš„ç±»å‹ï¼Œæ¯”å¦‚ text/json æˆ–è€… binary/my-binary-type
content-encoding | å†…å®¹çš„ç¼–ç ç±»å‹ï¼Œæ¯”å¦‚ utf-8 ç¼–ç çš„ Unicode æ–‡æœ¬ï¼ŒäºŒè¿›åˆ¶æ•°æ®

è¿™äº›å¤´ä¿¡æ¯å‘Šè¯‰æ¥æ”¶è€…æ¶ˆæ¯æ•°æ®ï¼Œè¿™æ ·çš„è¯ä½ å°±å¯ä»¥é€šè¿‡æä¾›ç»™æ¥æ”¶è€…è¶³å¤Ÿçš„ä¿¡æ¯è®©ä»–æ¥æ”¶åˆ°æ•°æ®çš„æ—¶å€™æ­£ç¡®çš„è§£ç çš„æ–¹å¼å‘å®ƒå‘é€ä»»ä½•æ•°æ®ï¼Œç”±äºå¤´ä¿¡æ¯æ˜¯å­—å…¸æ ¼å¼ï¼Œä½ å¯ä»¥éšæ„å‘å¤´ä¿¡æ¯ä¸­æ·»åŠ é”®å€¼å¯¹

## å‘é€åº”ç”¨ç¨‹åºæ¶ˆæ¯

ä¸è¿‡è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºæˆ‘ä»¬ä½¿ç”¨äº†å˜é•¿çš„å¤´ä¿¡æ¯ï¼Œè™½ç„¶æ–¹ä¾¿æ‰©å±•ä½†æ˜¯å½“ä½ ä½¿ç”¨ `recv()` æ–¹æ³•è¯»å–æ¶ˆæ¯çš„æ—¶å€™æ€ä¹ˆçŸ¥é“å¤´ä¿¡æ¯çš„é•¿åº¦å‘¢

æˆ‘ä»¬å‰é¢è®²åˆ°è¿‡ä½¿ç”¨ `recv()` æ¥æ”¶æ•°æ®å’Œå¦‚ä½•ç¡®å®šæ˜¯å¦æ¥æ”¶å®Œæˆï¼Œæˆ‘è¯´è¿‡å®šé•¿çš„å¤´å¯èƒ½ä¼šå¾ˆä½æ•ˆï¼Œçš„ç¡®å¦‚æ­¤ã€‚ä½†æ˜¯æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªæ¯”è¾ƒå°çš„ 2 å­—èŠ‚å®šé•¿çš„å¤´ä¿¡æ¯å‰ç¼€æ¥è¡¨ç¤ºå¤´ä¿¡æ¯çš„é•¿åº¦

ä½ å¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸€ç§æ··åˆçš„å‘é€æ¶ˆæ¯çš„å®ç°æ–¹æ³•ï¼Œæˆ‘ä»¬é€šè¿‡å‘é€å¤´ä¿¡æ¯é•¿åº¦æ¥å¼•å¯¼æ¥æ”¶è€…ï¼Œæ–¹ä¾¿ä»–ä»¬è§£ææ¶ˆæ¯ä½“

ä¸ºäº†ç»™ä½ æ›´å¥½åœ°è§£é‡Šæ¶ˆæ¯æ ¼å¼ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹æ¶ˆæ¯çš„å…¨è²Œï¼š

![message](https://files.realpython.com/media/sockets-app-message.2e131b0751e3.jpg)

æ¶ˆæ¯ä»¥ 2å­—èŠ‚çš„å›ºå®šé•¿åº¦çš„å¤´å¼€å§‹ï¼Œè¿™ä¸¤ä¸ªå­—èŠ‚æ˜¯æ•´å‹çš„ç½‘ç»œå­—èŠ‚åºåˆ—ï¼Œè¡¨ç¤ºä¸‹é¢çš„å˜é•¿ JSON å¤´ä¿¡æ¯çš„é•¿åº¦ï¼Œå½“æˆ‘ä»¬ä» `recv()` æ–¹æ³•è¯»å–åˆ° 2 ä¸ªå­—èŠ‚æ—¶å°±çŸ¥é“å®ƒè¡¨ç¤ºçš„æ˜¯å¤´ä¿¡æ¯é•¿åº¦çš„æ•´å½¢æ•°å­—ï¼Œç„¶ååœ¨è§£ç  JSON å¤´ä¹‹å‰è¯»å–è¿™ä¹ˆå¤šçš„å­—èŠ‚

JSON å¤´åŒ…å«äº†å¤´ä¿¡æ¯çš„å­—å…¸ã€‚å…¶ä¸­ä¸€ä¸ªå°±æ˜¯ `content-length`ï¼Œè¿™è¡¨ç¤ºæ¶ˆæ¯å†…å®¹çš„æ•°é‡ï¼ˆä¸æ˜¯JSONå¤´ï¼‰ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ `recv()` æ–¹æ³•è¯»å–åˆ°äº† `content-length` ä¸ªå­—èŠ‚çš„æ•°æ®æ—¶ï¼Œå°±è¡¨ç¤ºæ¥æ”¶å®Œæˆå¹¶ä¸”è¯»å–åˆ°äº†å®Œæ•´çš„æ¶ˆæ¯


## åº”ç”¨ç¨‹åºæ¶ˆæ¯ç±»

æœ€åè®©æˆ‘ä»¬æ¥çœ‹ä¸‹æˆæœï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªæ¶ˆæ¯ç±»ã€‚æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•åœ¨ socket å‘ç”Ÿè¯»å†™äº‹ä»¶æ—¶ä¸ `select()` é…åˆä½¿ç”¨çš„

å¯¹äºè¿™ä¸ªç¤ºä¾‹åº”ç”¨ç¨‹åºè€Œè¨€ï¼Œæˆ‘å¿…é¡»æƒ³å‡ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°†ä½¿ç”¨ä»€ä¹ˆç±»å‹çš„æ¶ˆæ¯ï¼Œä»è¿™ä¸€ç‚¹æ¥è®²è¿™è¿œè¿œè¶…è¿‡äº†æœ€æ—©æ—¶å€™æˆ‘ä»¬å†™çš„é‚£ä¸ªç©å…·ä¸€æ ·çš„æ‰“å°ç¨‹åº

ä¸ºäº†ä¿è¯ç¨‹åºç®€å•è€Œä¸”ä»ç„¶èƒ½å¤Ÿæ¼”ç¤ºå‡ºå®ƒæ˜¯å¦‚ä½•åœ¨ä¸€ä¸ªçœŸæ­£çš„ç¨‹åºä¸­å·¥ä½œçš„ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªåº”ç”¨ç¨‹åºåè®®ç”¨æ¥å®ç°åŸºæœ¬çš„æœç´¢åŠŸèƒ½ã€‚å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæœç´¢è¯·æ±‚ï¼ŒæœåŠ¡å™¨åšä¸€æ¬¡åŒ¹é…çš„æŸ¥æ‰¾ï¼Œå¦‚æœå®¢æˆ·ç«¯çš„è¯·æ±‚æ²¡æ³•è¢«è¯†åˆ«æˆæœç´¢è¯·æ±‚ï¼ŒæœåŠ¡å™¨å°±ä¼šå‡å®šè¿™ä¸ªæ˜¯äºŒè¿›åˆ¶è¯·æ±‚ï¼Œå¯¹åº”çš„è¿”å›äºŒè¿›åˆ¶å“åº”

è·Ÿç€ä¸‹é¢ä¸€èŠ‚ï¼Œè¿è¡Œç¤ºä¾‹ã€ç”¨ä»£ç åšå®éªŒåä½ å°†ä¼šçŸ¥é“ä»–æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œç„¶åä½ å°±å¯ä»¥ä»¥è¿™ä¸ªæ¶ˆæ¯ç±»ä¸ºèµ·ç‚¹æŠŠä»–ä¿®æ”¹æˆé€‚åˆè‡ªå·±ä½¿ç”¨çš„

å°±åƒæˆ‘ä»¬ä¹‹å‰è®¨è®ºçš„ï¼Œä½ å°†åœ¨ä¸‹é¢çœ‹åˆ°ï¼Œå¤„ç† socket æ—¶éœ€è¦ä¿å­˜çŠ¶æ€ã€‚é€šè¿‡ä½¿ç”¨ç±»ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰çš„çŠ¶æ€ã€æ•°æ®å’Œä»£ç æ‰“åŒ…åˆ°ä¸€ä¸ªåœ°æ–¹ã€‚å½“è¿æ¥å¼€å§‹æˆ–è€…æ¥å—çš„æ—¶å€™æ¶ˆæ¯ç±»å°±ä¼šä¸ºæ¯ä¸ª socket åˆ›å»ºä¸€ä¸ªå®ä¾‹

ç±»ä¸­çš„å¾ˆå¤šåŒ…è£…æ–¹æ³•ã€å·¥å…·æ–¹æ³•åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸Šéƒ½æ˜¯å·®ä¸å¤šçš„ã€‚å®ƒä»¬ä»¥ä¸‹åˆ’çº¿å¼€å¤´ï¼Œå°±åƒ `Message._json_encode()` ä¸€æ ·ï¼Œè¿™äº›æ–¹æ³•é€šè¿‡ç±»ä½¿ç”¨èµ·æ¥å¾ˆç®€å•ã€‚è¿™ä½¿å¾—å®ƒä»¬åœ¨å…¶å®ƒæ–¹æ³•ä¸­è°ƒç”¨æ—¶æ›´çŸ­ï¼Œè€Œä¸”ç¬¦åˆ [DRY](https://en.wikipedia.org/wiki/Don%27t_repeat_yourself) åŸåˆ™

æ¶ˆæ¯ç±»çš„æœåŠ¡ç«¯ç¨‹åºæœ¬è´¨ä¸Šå’Œå®¢æˆ·ç«¯ä¸€æ ·ã€‚ä¸åŒçš„æ˜¯å®¢æˆ·ç«¯åˆå§‹åŒ–è¿æ¥å¹¶å‘é€è¯·æ±‚æ¶ˆæ¯ï¼Œéšåè¦å¤„ç†æœåŠ¡ç«¯è¿”å›çš„å†…å®¹ã€‚è€ŒæœåŠ¡ç«¯åˆ™æ˜¯ç­‰å¾…è¿æ¥è¯·æ±‚ï¼Œå¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚æ¶ˆæ¯ï¼Œéšåå‘é€å“åº”æ¶ˆæ¯

çœ‹èµ·æ¥å°±åƒè¿™æ ·ï¼š

æ­¥éª¤ | ç«¯     | åŠ¨ä½œ/æ¶ˆæ¯å†…å®¹
:-   | :-     | :-
1    | å®¢æˆ·ç«¯ | å‘é€å¸¦æœ‰è¯·æ±‚å†…å®¹çš„æ¶ˆæ¯
2    | æœåŠ¡ç«¯ | æ¥æ”¶å¹¶å¤„ç†è¯·æ±‚æ¶ˆæ¯
3    | æœåŠ¡ç«¯ | å‘é€æœ‰å“åº”å†…å®¹çš„æ¶ˆæ¯
4    | å®¢æˆ·ç«¯ | æ¥æ”¶å¹¶å¤„ç†å“åº”æ¶ˆæ¯

ä¸‹é¢æ˜¯ä»£ç çš„ç»“æ„ï¼š

åº”ç”¨ç¨‹åº | æ–‡ä»¶          | ä»£ç 
:--      | :--           | :--
æœåŠ¡ç«¯   | app-server.py | æœåŠ¡ç«¯ä¸»ç¨‹åº
æœåŠ¡ç«¯   | libserver.py  | æœåŠ¡ç«¯æ¶ˆæ¯ç±»
å®¢æˆ·ç«¯   | app-client.py | å®¢æˆ·ç«¯ä¸»ç¨‹åº
å®¢æˆ·ç«¯   | libclient.py  | å®¢æˆ·ç«¯æ¶ˆæ¯ç±»


### æ¶ˆæ¯å…¥å£ç‚¹

æˆ‘æƒ³é€šè¿‡é¦–å…ˆæåˆ°å®ƒçš„è®¾è®¡æ–¹é¢æ¥è®¨è®º Message ç±»çš„å·¥ä½œæ–¹å¼ï¼Œä¸è¿‡è¿™å¯¹æˆ‘æ¥è¯´å¹¶ä¸æ˜¯ç«‹é©¬å°±èƒ½è§£é‡Šæ¸…æ¥šçš„ï¼Œåªæœ‰åœ¨é‡æ„å®ƒè‡³å°‘äº”æ¬¡ä¹‹åæˆ‘æ‰èƒ½è¾¾åˆ°å®ƒç›®å‰çš„çŠ¶æ€ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºè¦ç®¡ç†çŠ¶æ€

å½“æ¶ˆæ¯å¯¹è±¡åˆ›å»ºçš„æ—¶å€™ï¼Œå®ƒå°±è¢«ä¸€ä¸ªä½¿ç”¨ `selector.register()` äº‹ä»¶ç›‘æ§èµ·æ¥çš„ socket å…³è”èµ·æ¥äº†

```python
message = libserver.Message(sel, conn, addr)
sel.register(conn, selectors.EVENT_READ, data=message)
```

> æ³¨æ„ï¼Œè¿™ä¸€èŠ‚ä¸­çš„ä¸€äº›ä»£ç æ¥è‡ªæœåŠ¡ç«¯ä¸»ç¨‹åºä¸æ¶ˆæ¯ç±»ï¼Œä½†æ˜¯è¿™éƒ¨åˆ†å†…å®¹çš„è®¨è®ºåœ¨å®¢æˆ·ç«¯ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘å°†åœ¨ä»–ä»¬ä¹‹é—´å­˜åœ¨ä¸åŒç‚¹çš„æ—¶å€™æ¥è§£é‡Šå®¢æˆ·ç«¯çš„ç‰ˆæœ¬

å½“ socket ä¸Šçš„äº‹ä»¶å°±ç»ªçš„æ—¶å€™ï¼Œå®ƒå°±ä¼šè¢« `selector.select()` æ–¹æ³•è¿”å›ã€‚å¯¹è¿‡ key å¯¹è±¡çš„ data å±æ€§è·å–åˆ° message çš„å¼•ç”¨ï¼Œç„¶ååœ¨æ¶ˆæ¯ç”¨è°ƒç”¨ä¸€ä¸ªæ–¹æ³•ï¼š

```python
while True:
    events = sel.select(timeout=None)
    for key, mask in events:
        # ...
        message = key.data
        message.process_events(mask)
```

è§‚å¯Ÿä¸Šé¢çš„äº‹ä»¶å¾ªç¯ï¼Œå¯ä»¥çœ‹è§ `sel.select()` ä½äºã€Œå¸æœºä½ç½®ã€ï¼Œå®ƒæ˜¯é˜»å¡çš„ï¼Œåœ¨å¾ªç¯çš„ä¸Šé¢ç­‰å¾…ã€‚å½“ socket ä¸Šçš„è¯»å†™äº‹ä»¶å°±ç»ªæ—¶ï¼Œå®ƒå°±ä¼šä¸ºå…¶æœåŠ¡ã€‚è¿™è¡¨ç¤ºé—´æ¥çš„å®ƒä¹Ÿè¦è´Ÿè´£è°ƒç”¨ `process_events()` æ–¹æ³•ã€‚è¿™å°±æ˜¯æˆ‘è¯´ `process_events()` æ–¹æ³•æ˜¯å…¥å£çš„åŸå› 

è®©æˆ‘ä»¬æ¥çœ‹ä¸‹ `process_events()` æ–¹æ³•åšäº†ä»€ä¹ˆ

```python
def process_events(self, mask):
    if mask & selectors.EVENT_READ:
        self.read()
    if mask & selectors.EVENT_WRITE:
        self.write()
```

è¿™æ ·åšå¾ˆå¥½ï¼Œå› ä¸º `process_events()` æ–¹æ³•å¾ˆç®€æ´ï¼Œå®ƒåªå¯ä»¥åšä¸¤ä»¶äº‹æƒ…ï¼šè°ƒç”¨ `read()` å’Œ `write()` æ–¹æ³•

è¿™åˆæŠŠæˆ‘ä»¬å¸¦å›äº†çŠ¶æ€ç®¡ç†çš„é—®é¢˜ã€‚åœ¨å‡ æ¬¡é‡æ„åï¼Œæˆ‘å†³å®šå¦‚æœåˆ«çš„æ–¹æ³•ä¾èµ–äºçŠ¶æ€å˜é‡é‡Œé¢çš„æŸä¸ªç¡®å®šå€¼ï¼Œé‚£ä¹ˆå®ƒä»¬å°±åªåº”è¯¥ä» `read()` å’Œ `write()` æ–¹æ³•ä¸­è°ƒç”¨ï¼Œè¿™å°†ä½¿å¤„ç†socket äº‹ä»¶çš„é€»è¾‘å°½é‡çš„ç®€å•

å¯èƒ½è¯´èµ·æ¥å¾ˆç®€å•ï¼Œä½†æ˜¯ç»å†äº†å‰é¢å‡ æ¬¡ç±»çš„è¿­ä»£ï¼šæ··åˆäº†ä¸€äº›æ–¹æ³•ï¼Œæ£€æŸ¥å½“å‰çŠ¶æ€ã€ä¾èµ–äºå…¶å®ƒå€¼ã€åœ¨ `read()` æˆ–è€… `write()` æ–¹æ³•å¤–é¢è°ƒç”¨å¤„ç†æ•°æ®çš„æ–¹æ³•ï¼Œæœ€åè¿™è¯æ˜äº†è¿™æ ·ç®¡ç†èµ·æ¥å¾ˆå¤æ‚

å½“ç„¶ï¼Œä½ è‚¯å®šéœ€è¦æŠŠç±»æŒ‰ä½ è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹ä½¿å®ƒèƒ½å¤Ÿç¬¦åˆä½ çš„é¢„æœŸï¼Œä½†æ˜¯æˆ‘å»ºè®®ä½ å°½å¯èƒ½æŠŠçŠ¶æ€æ£€æŸ¥ã€ä¾èµ–çŠ¶æ€çš„è°ƒç”¨çš„é€»è¾‘æ”¾åœ¨ `read()` å’Œ `write()` æ–¹æ³•é‡Œé¢

è®©æˆ‘ä»¬æ¥çœ‹çœ‹ `read()` æ–¹æ³•ï¼Œè¿™æ˜¯æœåŠ¡ç«¯ç‰ˆæœ¬ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ä¸åŒä¹‹å¤„åœ¨äºæ–¹æ³•åç§°ï¼Œä¸€ä¸ªï¼ˆå®¢æˆ·ç«¯ï¼‰æ˜¯ `process_response()` å¦ä¸€ä¸ªï¼ˆæœåŠ¡ç«¯ï¼‰æ˜¯ `process_request()`

```python
def read(self):
    self._read()

    if self._jsonheader_len is None:
        self.process_protoheader()

    if self._jsonheader_len is not None:
        if self.jsonheader is None:
            self.process_jsonheader()

    if self.jsonheader:
        if self.request is None:
            self.process_request()
```

`_read()` æ–¹æ³•é¦–å…ˆè¢«è°ƒç”¨ï¼Œç„¶åè°ƒç”¨ `socket.recv()` ä» socket è¯»å–æ•°æ®å¹¶å­˜å…¥åˆ°æ¥æ”¶ç¼“å†²åŒº

è®°ä½ï¼Œå½“è°ƒç”¨ `socket.recv()` æ–¹æ³•æ—¶ï¼Œç»„æˆæ¶ˆæ¯çš„æ‰€æœ‰æ•°æ®å¹¶æ²¡æœ‰ä¸€æ¬¡æ€§å…¨éƒ¨åˆ°è¾¾ã€‚`socket.recv()` æ–¹æ³•å¯èƒ½éœ€è¦è°ƒç”¨å¾ˆå¤šæ¬¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨è°ƒç”¨ç›¸å…³æ–¹æ³•å¤„ç†æ•°æ®å‰æ¯æ¬¡éƒ½è¦æ£€æŸ¥çŠ¶æ€

å½“ä¸€ä¸ªæ–¹æ³•å¼€å§‹å¤„ç†æ¶ˆæ¯æ—¶ï¼Œé¦–å…ˆè¦æ£€æŸ¥çš„å°±æ˜¯æ¥å—ç¼“å†²åŒºä¿å­˜äº†è¶³å¤Ÿçš„å¤šè¯»å–çš„æ•°æ®ï¼Œå¦‚æœç¡®å®šï¼Œå®ƒä»¬å°†ç»§ç»­å¤„ç†å„è‡ªçš„æ•°æ®ï¼Œç„¶åæŠŠæ•°æ®å­˜åˆ°å…¶å®ƒæµç¨‹å¯èƒ½ä¼šç”¨åˆ°çš„å˜é‡ä¸Šï¼Œå¹¶ä¸”æ¸…ç©ºè‡ªå·±çš„ç¼“å†²åŒºã€‚ç”±äºä¸€ä¸ªæ¶ˆæ¯æœ‰ä¸‰ä¸ªç»„ä»¶ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸‰ä¸ªçŠ¶æ€æ£€æŸ¥å’Œå¤„ç†æ–¹æ³•çš„è°ƒç”¨ï¼š

Message Component   | Method                | Output
--                  | --                    | --
Fixed-length header | process_protoheader() | self._jsonheader_len
JSON header         | process_jsonheader()  | self.jsonheader
Content             | process_request()     | self.request

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ `write()` æ–¹æ³•ï¼Œè¿™æ˜¯æœåŠ¡ç«¯çš„ç‰ˆæœ¬ï¼š

```python
def write(self):
    if self.request:
        if not self.response_created:
            self.create_response()

    self._write()
```

`write()` æ–¹æ³•ä¼šé¦–å…ˆæ£€æµ‹æ˜¯å¦æœ‰è¯·æ±‚ï¼Œå¦‚æœæœ‰è€Œä¸”å“åº”è¿˜æ²¡è¢«åˆ›å»ºçš„è¯ `create_response()` æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ï¼Œå®ƒä¼šè®¾ç½®çŠ¶æ€å˜é‡ `response_created`ï¼Œç„¶åä¸ºå‘é€ç¼“å†²åŒºå†™å…¥å“åº”

å¦‚æœå‘é€ç¼“å†²åŒºæœ‰æ•°æ®ï¼Œ`write()` æ–¹æ³•ä¼šè°ƒç”¨ `socket.send()` æ–¹æ³•

è®°ä½ï¼Œå½“ `socket.send()` è¢«è°ƒç”¨æ—¶ï¼Œæ‰€æœ‰å‘é€ç¼“å†²åŒºçš„æ•°æ®å¯èƒ½è¿˜æ²¡è¿›å…¥åˆ°å‘é€é˜Ÿåˆ—ï¼Œsocket çš„ç½‘ç»œç¼“å†²åŒºå¯èƒ½æ»¡äº†ï¼Œ`socket.send()` å¯èƒ½éœ€è¦é‡æ–°è°ƒç”¨ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥çŠ¶æ€çš„åŸå› ï¼Œ`create_response()` åº”è¯¥åªè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä½†æ˜¯ `_write()` æ–¹æ³•éœ€è¦è°ƒç”¨å¤šæ¬¡

å®¢æˆ·ç«¯çš„ `write()` ç‰ˆå¤§ä½“ä¸æœåŠ¡ç«¯ä¸€è‡´ï¼š

```python
def write(self):
    if not self._request_queued:
        self.queue_request()

    self._write()

    if self._request_queued:
        if not self._send_buffer:
            # Set selector to listen for read events, we're done writing.
            self._set_selector_events_mask('r')
```

å› ä¸ºå®¢æˆ·ç«¯é¦–å…ˆåˆå§‹åŒ–äº†ä¸€ä¸ªè¿æ¥è¯·æ±‚åˆ°æœåŠ¡ç«¯ï¼ŒçŠ¶æ€å˜é‡`_request_queued`è¢«æ£€æŸ¥ã€‚å¦‚æœè¯·æ±‚è¿˜æ²¡åŠ å…¥åˆ°é˜Ÿåˆ—ï¼Œå°±è°ƒç”¨ `queue_request()` æ–¹æ³•åˆ›å»ºä¸€ä¸ªè¯·æ±‚å†™å…¥åˆ°å‘é€ç¼“å†²åŒºä¸­ï¼ŒåŒæ—¶ä¹Ÿä¼šä½¿ç”¨å˜é‡ `_request_queued` è®°å½•çŠ¶æ€å€¼é˜²æ­¢å¤šæ¬¡è°ƒç”¨

å°±åƒæœåŠ¡ç«¯ä¸€æ ·ï¼Œå¦‚æœå‘é€ç¼“å†²åŒºæœ‰æ•°æ® `_write()` æ–¹æ³•ä¼šè°ƒç”¨ `socket.send()` æ–¹æ³•

éœ€è¦æ³¨æ„å®¢æˆ·ç«¯ç‰ˆæœ¬çš„ `write()` æ–¹æ³•ä¸æœåŠ¡ç«¯ä¸åŒä¹‹å¤„åœ¨äºæœ€åçš„è¯·æ±‚æ˜¯å¦åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­çš„æ£€æŸ¥ï¼Œè¿™ä¸ªæˆ‘ä»¬å°†åœ¨å®¢æˆ·ç«¯ä¸»ç¨‹åºä¸­è¯¦ç»†è§£é‡Šï¼ŒåŸå› æ˜¯è¦å‘Šè¯‰ `selector.select()`åœæ­¢ç›‘æ§ socket çš„å†™å…¥äº‹ä»¶è€Œä¸”æˆ‘ä»¬åªå¯¹è¯»å–äº‹ä»¶æ„Ÿå…´è¶£ï¼Œæ²¡æœ‰åŠæ³•é€šçŸ¥å¥—æ¥å­—æ˜¯å¯å†™çš„

æˆ‘å°†åœ¨è¿™ä¸€èŠ‚ä¸­ç•™ä¸‹ä¸€ä¸ªæ‚¬å¿µï¼Œè¿™ä¸€èŠ‚çš„ä¸»è¦ç›®çš„æ˜¯è§£é‡Š `selector.select()` æ–¹æ³•æ˜¯å¦‚ä½•é€šè¿‡ `process_events()` æ–¹æ³•è°ƒç”¨æ¶ˆæ¯ç±»ä»¥åŠå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„

è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸º `process_events()` æ–¹æ³•åœ¨è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸä¸­å°†è¢«è°ƒç”¨å¾ˆå¤šæ¬¡ï¼Œå› æ­¤ï¼Œè¦ç¡®ä¿é‚£äº›åªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡çš„æ–¹æ³•æ­£å¸¸å·¥ä½œï¼Œè¿™äº›æ–¹æ³•ä¸­è¦ä¹ˆéœ€è¦æ£€æŸ¥è‡ªå·±çš„çŠ¶æ€å˜é‡ï¼Œè¦ä¹ˆéœ€è¦æ£€æŸ¥è°ƒç”¨è€…çš„æ–¹æ³•ä¸­çš„çŠ¶æ€å˜é‡

### æœåŠ¡ç«¯ä¸»ç¨‹åº

åœ¨æœåŠ¡ç«¯ä¸»ç¨‹åº `app-server.py` ä¸­ï¼Œä¸»æœºã€ç«¯å£å‚æ•°æ˜¯é€šè¿‡å‘½ä»¤è¡Œä¼ é€’ç»™ç¨‹åºçš„ï¼š

```bash
$ ./app-server.py
usage: ./app-server.py <host> <port>
```

ä¾‹å¦‚éœ€æ±‚ç›‘å¬æœ¬åœ°å›ç¯åœ°å€ä¸Šé¢çš„ 65432 ç«¯å£ï¼Œéœ€è¦æ‰§è¡Œï¼š

```bash
$ ./app-server.py 127.0.0.1 65432
listening on ('127.0.0.1', 65432)
```

`<host>` å‚æ•°ä¸ºç©ºçš„è¯å°±å¯ä»¥ç›‘å¬ä¸»æœºä¸Šçš„æ‰€æœ‰ IP åœ°å€

åˆ›å»ºå®Œ socket åï¼Œä¸€ä¸ªä¼ å…¥å‚æ•° `socket.SO_REUSEADDR` çš„æ–¹æ³• `to
socket.setsockopt()` å°†è¢«è°ƒç”¨

```python
# Avoid bind() exception: OSError: [Errno 48] Address already in use
lsock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
```

è®¾ç½®è¿™ä¸ªå‚æ•°æ˜¯ä¸ºäº†é¿å… `ç«¯å£è¢«å ç”¨` çš„é”™è¯¯å‘ç”Ÿï¼Œå¦‚æœå½“å‰ç¨‹åºä½¿ç”¨çš„ç«¯å£å’Œä¹‹å‰çš„ç¨‹åºä½¿ç”¨çš„ä¸€æ ·ï¼Œä½ å°±ä¼šå‘ç°è¿æ¥å¤„äº `TIME_WAIT` çŠ¶æ€

æ¯”å¦‚è¯´ï¼Œå¦‚æœæœåŠ¡å™¨ä¸»åŠ¨å…³é—­è¿æ¥ï¼ŒæœåŠ¡å™¨ä¼šä¿æŒä¸ºå¤§æ¦‚ä¸¤åˆ†é’Ÿçš„ `TIME_WAIT` çŠ¶æ€ï¼Œå…·ä½“æ—¶é•¿å–å†³äºä½ çš„æ“ä½œç³»ç»Ÿã€‚å¦‚æœä½ æƒ³åœ¨ä¸¤åˆ†é’Ÿå†…å†å¼€å¯ä¸€ä¸ªæœåŠ¡ï¼Œä½ å°†å¾—åˆ°ä¸€ä¸ª`OSError` è¡¨ç¤º `ç«¯å£è¢«æˆ˜èƒœ`ï¼Œè¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿ä¸€äº›åœ¨é€”çš„æ•°æ®åŒ…æ­£ç¡®çš„è¢«å¤„ç†

äº‹ä»¶å¾ªç¯ä¼šæ•æ‰æ‰€æœ‰é”™è¯¯ï¼Œä»¥ä¿è¯æœåŠ¡å™¨æ­£å¸¸è¿è¡Œï¼š

```python
while True:
    events = sel.select(timeout=None)
    for key, mask in events:
        if key.data is None:
            accept_wrapper(key.fileobj)
        else:
            message = key.data
            try:
                message.process_events(mask)
            except Exception:
                print('main: error: exception for',
                      f'{message.addr}:\n{traceback.format_exc()}')
                message.close()
```

å½“æœåŠ¡å™¨æ¥å—åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œæ¶ˆæ¯å¯¹è±¡å°±ä¼šè¢«åˆ›å»ºï¼š

```bash
def accept_wrapper(sock):
    conn, addr = sock.accept()  # Should be ready to read
    print('accepted connection from', addr)
    conn.setblocking(False)
    message = libserver.Message(sel, conn, addr)
    sel.register(conn, selectors.EVENT_READ, data=message)
```

æ¶ˆæ¯å¯¹è±¡ä¼šé€šè¿‡ `sel.register()` æ–¹æ³•å…³è”åˆ° socket ä¸Šï¼Œè€Œä¸”å®ƒåˆå§‹åŒ–å°±è¢«è®¾ç½®æˆäº†åªç›‘æ§è¯»äº‹ä»¶ã€‚å½“è¯·æ±‚è¢«è¯»å–æ—¶ï¼Œæˆ‘ä»¬å°†é€šè¿‡ç›‘å¬åˆ°çš„å†™äº‹ä»¶ä¿®æ”¹å®ƒ

åœ¨æœåŠ¡å™¨ç«¯é‡‡ç”¨è¿™ç§æ–¹æ³•çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå½“ socket æ­£å¸¸å¹¶ä¸”æ²¡æœ‰ç½‘ç»œé—®é¢˜æ—¶ï¼Œå®ƒå§‹ç»ˆæ˜¯å¯å†™çš„

å¦‚æœæˆ‘ä»¬å‘Šè¯‰ `sel.register()` æ–¹æ³•ç›‘æ§ `EVENT_WRITE` å†™å…¥äº‹ä»¶ï¼Œäº‹ä»¶å¾ªç¯å°†ä¼šç«‹å³å”¤é†’å¹¶é€šçŸ¥æˆ‘ä»¬è¿™ç§æƒ…å†µï¼Œç„¶è€Œæ­¤æ—¶ socket å¹¶ä¸ç”¨å”¤é†’è°ƒç”¨ `send()` æ–¹æ³•ã€‚ç”±äºè¯·æ±‚è¿˜æ²¡è¢«å¤„ç†ï¼Œæ‰€ä»¥ä¸éœ€è¦å‘å›å“åº”ã€‚è¿™å°†æ¶ˆè€—å¹¶æµªè´¹å®è´µçš„ CPU å‘¨æœŸ

### æœåŠ¡ç«¯æ¶ˆæ¯ç±»

åœ¨æ¶ˆæ¯åˆ‡å…¥ç‚¹ä¸€èŠ‚ä¸­ï¼Œå½“é€šè¿‡ `process_events()` çŸ¥é“ socket äº‹ä»¶å°±ç»ªæ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¶ˆæ¯å¯¹è±¡æ˜¯å¦‚ä½•å‘å‡ºåŠ¨ä½œçš„ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹å½“æ•°æ®åœ¨ socket ä¸Šè¢«è¯»å–æ˜¯ä¼šå‘ç”Ÿäº›ä»€ä¹ˆï¼Œä»¥åŠä¸ºæœåŠ¡å™¨å°±ç»ªçš„æ¶ˆæ¯çš„ç»„ä»¶ç‰‡æ®µå‘ç”Ÿäº†ä»€ä¹ˆ

`libserver.py` æ–‡ä»¶ä¸­çš„æœåŠ¡ç«¯æ¶ˆæ¯ç±»ï¼Œå¯ä»¥åœ¨ Github ä¸Šæ‰¾åˆ° [æºä»£ç ](https://github.com/realpython/materials/tree/master/python-sockets-tutorial)

è¿™äº›æ–¹æ³•æŒ‰ç…§æ¶ˆæ¯å¤„ç†é¡ºåºå‡ºç°åœ¨ç±»ä¸­

å½“æœåŠ¡å™¨è¯»å–åˆ°è‡³å°‘ä¸¤ä¸ªå­—èŠ‚æ—¶ï¼Œå®šé•¿å¤´çš„é€»è¾‘å°±å¯ä»¥å¼€å§‹äº†

```python
def process_protoheader(self):
    hdrlen = 2
    if len(self._recv_buffer) >= hdrlen:
        self._jsonheader_len = struct.unpack('>H',
                                             self._recv_buffer[:hdrlen])[0]
        self._recv_buffer = self._recv_buffer[hdrlen:]
```

ç½‘ç»œå­—èŠ‚åºåˆ—ä¸­çš„å®šé•¿æ•´å‹ä¸¤å­—èŠ‚åŒ…å«äº† JSON å¤´çš„é•¿åº¦ï¼Œ`struct.unpack()` æ–¹æ³•ç”¨æ¥è¯»å–å¹¶è§£ç ï¼Œç„¶åä¿å­˜åœ¨ `self._jsonheader_len` ä¸­ï¼Œå½“è¿™éƒ¨åˆ†æ¶ˆæ¯è¢«å¤„ç†å®Œæˆåï¼Œå°±è¦è°ƒç”¨ `process_protoheader()` æ–¹æ³•æ¥åˆ é™¤æ¥æ”¶ç¼“å†²åŒºä¸­å¤„ç†è¿‡çš„æ¶ˆæ¯

å°±åƒä¸Šé¢çš„å®šé•¿å¤´çš„é€»è¾‘ä¸€æ ·ï¼Œå½“æ¥æ”¶ç¼“å†²åŒºæœ‰è¶³å¤Ÿçš„ JSON å¤´æ•°æ®æ—¶ï¼Œå®ƒä¹Ÿéœ€è¦è¢«å¤„ç†ï¼š

```python
def process_jsonheader(self):
    hdrlen = self._jsonheader_len
    if len(self._recv_buffer) >= hdrlen:
        self.jsonheader = self._json_decode(self._recv_buffer[:hdrlen],
                                            'utf-8')
        self._recv_buffer = self._recv_buffer[hdrlen:]
        for reqhdr in ('byteorder', 'content-length', 'content-type',
                       'content-encoding'):
            if reqhdr not in self.jsonheader:
                raise ValueError(f'Missing required header "{reqhdr}".')
```

`self._json_decode()` æ–¹æ³•ç”¨æ¥è§£ç å¹¶ååºåˆ—åŒ– JSON å¤´æˆä¸€ä¸ªå­—å…¸ã€‚ç”±äºæˆ‘ä»¬å®šä¹‰çš„ JSON å¤´æ˜¯ utf-8 æ ¼å¼çš„ï¼Œæ‰€ä»¥è§£ç æ–¹æ³•è°ƒç”¨æ—¶æˆ‘ä»¬å†™æ­»äº†è¿™ä¸ªå‚æ•°ï¼Œç»“æœå°†è¢«å­˜æ”¾åœ¨ `self.jsonheader` ä¸­ï¼Œ`process_jsonheader` æ–¹æ³•åšå®Œä»–åº”è¯¥åšçš„äº‹æƒ…åï¼ŒåŒæ ·éœ€è¦åˆ é™¤æ¥æ”¶ç¼“å†²åŒºä¸­å¤„ç†è¿‡çš„æ¶ˆæ¯

æ¥ä¸‹æ¥å°±æ˜¯çœŸæ­£çš„æ¶ˆæ¯å†…å®¹ï¼Œå½“æ¥æ”¶ç¼“å†²åŒºæœ‰ JSON å¤´ä¸­å®šä¹‰çš„ `content-length` å€¼çš„æ•°é‡ä¸ªå­—èŠ‚æ—¶ï¼Œè¯·æ±‚å°±åº”è¯¥è¢«å¤„ç†äº†ï¼š

```python
def process_request(self):
    content_len = self.jsonheader['content-length']
    if not len(self._recv_buffer) >= content_len:
        return
    data = self._recv_buffer[:content_len]
    self._recv_buffer = self._recv_buffer[content_len:]
    if self.jsonheader['content-type'] == 'text/json':
        encoding = self.jsonheader['content-encoding']
        self.request = self._json_decode(data, encoding)
        print('received request', repr(self.request), 'from', self.addr)
    else:
        # Binary or unknown content-type
        self.request = data
        print(f'received {self.jsonheader["content-type"]} request from',
              self.addr)
    # Set selector to listen for write events, we're done reading.
    self._set_selector_events_mask('w')
```

æŠŠæ¶ˆæ¯ä¿å­˜åˆ° `data` å˜é‡ä¸­åï¼Œ`process_request()` åˆä¼šåˆ é™¤æ¥æ”¶ç¼“å†²åŒºä¸­å¤„ç†è¿‡çš„æ•°æ®ã€‚æ¥ç€ï¼Œå¦‚æœ content type æ˜¯ JSON çš„è¯ï¼Œå®ƒå°†è§£ç å¹¶ååºåˆ—åŒ–æ•°æ®ã€‚å¦åˆ™ï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼‰æ•°æ®å°†è¢«è§† åšäºŒè¿›åˆ¶æ•°æ®å¹¶æ‰“å°å‡ºæ¥

æœ€å `process_request()` æ–¹æ³•ä¼šä¿®æ”¹ selector ä¸ºåªç›‘æ§å†™å…¥äº‹ä»¶ã€‚åœ¨æœåŠ¡ç«¯çš„ç¨‹åº `app-server.py` ä¸­ï¼Œsocket åˆå§‹åŒ–è¢«è®¾ç½®æˆä»…ç›‘æ§è¯»äº‹ä»¶ã€‚ç°åœ¨è¯·æ±‚å·²ç»è¢«å…¨éƒ¨å¤„ç†å®Œäº†ï¼Œæˆ‘ä»¬å¯¹è¯»å–äº‹ä»¶å°±ä¸æ„Ÿå…´è¶£äº†

ç°åœ¨å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªå“åº”å†™å…¥åˆ° socket ä¸­ã€‚å½“ socket å¯å†™æ—¶ `create_response()` å°†è¢«ä» `write()` æ–¹æ³•ä¸­è°ƒç”¨ï¼š

```python
def create_response(self):
    if self.jsonheader['content-type'] == 'text/json':
        response = self._create_response_json_content()
    else:
        # Binary or unknown content-type
        response = self._create_response_binary_content()
    message = self._create_message(**response)
    self.response_created = True
    self._send_buffer += message
```

å“åº”ä¼šæ ¹æ®ä¸åŒçš„ content type çš„ä¸åŒè€Œè°ƒç”¨ä¸åŒçš„æ–¹æ³•åˆ›å»ºã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå½“ `action == 'search'` çš„æ—¶å€™ä¼šæ‰§è¡Œä¸€ä¸ªç®€å•çš„å­—å…¸æŸ¥æ‰¾ã€‚ä½ å¯ä»¥åœ¨è¿™ä¸ªåœ°æ–¹æ·»åŠ ä½ è‡ªå·±çš„å¤„ç†æ–¹æ³•å¹¶è°ƒç”¨

ä¸€ä¸ªä¸å¥½å¤„ç†çš„é—®é¢˜æ˜¯å“åº”å†™å…¥å®Œæˆæ—¶å¦‚ä½•å…³é—­è¿æ¥ï¼Œæˆ‘ä¼šåœ¨ `_write()` æ–¹æ³•ä¸­è°ƒç”¨ `close()`

```python
def _write(self):
    if self._send_buffer:
        print('sending', repr(self._send_buffer), 'to', self.addr)
        try:
            # Should be ready to write
            sent = self.sock.send(self._send_buffer)
        except BlockingIOError:
            # Resource temporarily unavailable (errno EWOULDBLOCK)
            pass
        else:
            self._send_buffer = self._send_buffer[sent:]
            # Close when the buffer is drained. The response has been sent.
            if sent and not self._send_buffer:
                self.close()
```

è™½ç„¶`close()` æ–¹æ³•çš„è°ƒç”¨æœ‰ç‚¹éšè”½ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºè¿™æ˜¯ä¸€ç§æƒè¡¡ã€‚å› ä¸ºæ¶ˆæ¯ç±»ä¸€ä¸ªè¿æ¥åªå¤„ç†ä¸€æ¡æ¶ˆæ¯ã€‚å†™å…¥å“åº”åï¼ŒæœåŠ¡å™¨æ— éœ€æ‰§è¡Œä»»ä½•æ“ä½œã€‚å®ƒçš„ä»»åŠ¡å°±å®Œæˆäº†

### å®¢æˆ·ç«¯ä¸»ç¨‹åº

å®¢æˆ·ç«¯ä¸»ç¨‹åº `app-client.py` ä¸­ï¼Œå‚æ•°ä»å‘½ä»¤è¡Œä¸­è¯»å–ï¼Œç”¨æ¥åˆ›å»ºè¯·æ±‚å¹¶è¿æ¥åˆ°æœåŠ¡ç«¯

```bash
$ ./app-client.py
usage: ./app-client.py <host> <port> <action> <value>
```

æ¥ä¸ªç¤ºä¾‹æ¼”ç¤ºä¸€ä¸‹ï¼š

```bash
$ ./app-client.py 127.0.0.1 65432 search needle
```

å½“ä»å‘½ä»¤è¡Œå‚æ•°åˆ›å»ºå®Œä¸€ä¸ªå­—å…¸æ¥è¡¨ç¤ºè¯·æ±‚åï¼Œä¸»æœºã€ç«¯å£ã€è¯·æ±‚å­—å…¸ä¸€èµ·è¢«ä¼ ç»™ `start_connection()`

```python
def start_connection(host, port, request):
    addr = (host, port)
    print('starting connection to', addr)
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.setblocking(False)
    sock.connect_ex(addr)
    events = selectors.EVENT_READ | selectors.EVENT_WRITE
    message = libclient.Message(sel, sock, addr, request)
    sel.register(sock, events, data=message)
```

å¯¹æœåŠ¡å™¨çš„ socket è¿æ¥è¢«åˆ›å»ºï¼Œæ¶ˆæ¯å¯¹è±¡è¢«ä¼ å…¥è¯·æ±‚å­—å…¸å¹¶åˆ›å»º

å’ŒæœåŠ¡ç«¯ä¸€æ ·ï¼Œæ¶ˆæ¯å¯¹è±¡åœ¨ `sel.register()` æ–¹æ³•ä¸­è¢«å…³è”åˆ° socket ä¸Šã€‚ç„¶è€Œï¼Œå®¢æˆ·ç«¯ä¸åŒçš„æ˜¯ï¼Œsocket åˆå§‹åŒ–çš„æ—¶å€™ä¼šç›‘æ§è¯»å†™äº‹ä»¶ï¼Œä¸€æ—¦è¯·æ±‚è¢«å†™å…¥ï¼Œæˆ‘ä»¬å°†ä¼šä¿®æ”¹ä¸ºåªç›‘æ§è¯»å–äº‹ä»¶

è¿™ç§å®ç°å’ŒæœåŠ¡ç«¯ä¸€æ ·æœ‰å¥½å¤„ï¼šä¸æµªè´¹ CPU ç”Ÿå‘½å‘¨æœŸã€‚è¯·æ±‚å‘é€å®Œæˆåï¼Œæˆ‘ä»¬å°±ä¸å…³æ³¨å†™å…¥äº‹ä»¶äº†ï¼Œæ‰€ä»¥ä¸ç”¨ä¿æŒçŠ¶æ€ç­‰å¾…å¤„ç†

### å®¢æˆ·ç«¯æ¶ˆæ¯ç±»

åœ¨ [æ¶ˆæ¯å…¥å£ç‚¹](#æ¶ˆæ¯å…¥å£ç‚¹) ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°è¿‡ï¼Œå½“ socket ä½¿ç”¨å‡†å¤‡å°±ç»ªæ—¶ï¼Œæ¶ˆæ¯å¯¹è±¡æ˜¯å¦‚ä½•è°ƒç”¨å…·ä½“åŠ¨ä½œçš„ã€‚ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹ socket ä¸Šçš„æ•°æ®æ˜¯å¦‚ä½•è¢«è¯»å†™çš„ï¼Œä»¥åŠæ¶ˆæ¯å‡†å¤‡å¥½è¢«åŠ å·¥çš„æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆ

å®¢æˆ·ç«¯æ¶ˆæ¯ç±»åœ¨ `libclient.py` æ–‡ä»¶ä¸­ï¼Œå¯ä»¥åœ¨ Github ä¸Šæ‰¾åˆ° [æºä»£ç ](https://github.com/realpython/materials/tree/master/python-sockets-tutorial)

è¿™äº›æ–¹æ³•æŒ‰ç…§æ¶ˆæ¯å¤„ç†é¡ºåºå‡ºç°åœ¨ç±»ä¸­

å®¢æˆ·ç«¯çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å°±æ˜¯è®©è¯·æ±‚å…¥é˜Ÿåˆ—ï¼š

```python
def queue_request(self):
    content = self.request['content']
    content_type = self.request['type']
    content_encoding = self.request['encoding']
    if content_type == 'text/json':
        req = {
            'content_bytes': self._json_encode(content, content_encoding),
            'content_type': content_type,
            'content_encoding': content_encoding
        }
    else:
        req = {
            'content_bytes': content,
            'content_type': content_type,
            'content_encoding': content_encoding
        }
    message = self._create_message(**req)
    self._send_buffer += message
    self._request_queued = True
```

ç”¨æ¥åˆ›å»ºè¯·æ±‚çš„å­—å…¸ï¼Œå–å†³äºå®¢æˆ·ç«¯ç¨‹åº `app-client.py` ä¸­ä¼ å…¥çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œå½“æ¶ˆæ¯å¯¹è±¡åˆ›å»ºçš„æ—¶å€™ï¼Œè¯·æ±‚å­—å…¸è¢«å½“åšå‚æ•°ä¼ å…¥

è¯·æ±‚æ¶ˆæ¯è¢«åˆ›å»ºå¹¶è¿½åŠ åˆ°å‘é€ç¼“å†²åŒºä¸­ï¼Œæ¶ˆæ¯å°†è¢« `_write()` æ–¹æ³•å‘é€ï¼ŒçŠ¶æ€å‚æ•° `self._request_queued` è¢«è®¾ç½®ï¼Œè¿™ä½¿ `queue_request()` æ–¹æ³•ä¸ä¼šè¢«é‡å¤è°ƒç”¨

è¯·æ±‚å‘é€å®Œæˆåï¼Œå®¢æˆ·ç«¯å°±ç­‰å¾…æœåŠ¡å™¨çš„å“åº”

å®¢æˆ·ç«¯è¯»å–å’Œå¤„ç†æ¶ˆæ¯çš„æ–¹æ³•å’ŒæœåŠ¡ç«¯ä¸€è‡´ï¼Œç”±äºå“åº”æ•°æ®æ˜¯ä» socket ä¸Šè¯»å–çš„ï¼Œæ‰€ä»¥å¤„ç† header çš„æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼š`process_protoheader()` å’Œ `process_jsonheader()`

æœ€ç»ˆå¤„ç†æ–¹æ³•åå­—çš„ä¸åŒåœ¨äºå¤„ç†ä¸€ä¸ªå“åº”ï¼Œè€Œä¸æ˜¯åˆ›å»ºï¼š`process_response()`,`_process_response_json_content()` å’Œ `_process_response_binary_content()`

æœ€åï¼Œä½†è‚¯å®šä¸æ˜¯æœ€ä¸é‡è¦çš„ â€”â€” æœ€ç»ˆçš„ `process_response()` è°ƒç”¨ï¼š

```python
def process_response(self):
    # ...
    # Close when response has been processed
    self.close()
```

### æ¶ˆæ¯ç±»çš„åŒ…è£…

æˆ‘å°†é€šè¿‡æåŠä¸€äº›æ–¹æ³•çš„é‡è¦æ³¨æ„ç‚¹æ¥ç»“æŸæ¶ˆæ¯ç±»çš„è®¨è®º

ä¸»ç¨‹åºä¸­ä»»æ„çš„ç±»è§¦å‘å¼‚å¸¸éƒ½ç”± `except` å­—å¥æ¥å¤„ç†ï¼š

```python
try:
    message.process_events(mask)
except Exception:
    print('main: error: exception for',
          f'{message.addr}:\n{traceback.format_exc()}')
    message.close()
```

æ³¨æ„æœ€åä¸€è¡Œçš„æ–¹æ³• `message.close()`

è¿™ä¸€è¡Œå¾ˆé‡è¦çš„åŸå› æœ‰å¾ˆå¤šï¼Œä¸ä»…ä»…æ˜¯ä¿è¯ socket è¢«å…³é—­ï¼Œè€Œä¸”é€šè¿‡è°ƒç”¨ `message.close()` æ–¹æ³•åˆ é™¤ä½¿ç”¨ `select()` ç›‘æ§çš„ socketï¼Œè¿™æ˜¯ç±»ä¸­çš„ä¸€æ®µéå¸¸ç®€æ´çš„ä»£ç ï¼Œå®ƒèƒ½å‡å°å¤æ‚åº¦ã€‚å¦‚æœä¸€ä¸ªå¼‚å¸¸å‘ç”Ÿæˆ–è€…æˆ‘ä»¬è‡ªå·±ä¸»åŠ¨æŠ›å‡ºï¼Œæˆ‘ä»¬å¾ˆæ¸…æ¥š `close()` æ–¹æ³•å°†å¤„ç†å–„å

`Message._read()` å’Œ `Message._write()` æ–¹æ³•éƒ½åŒ…å«ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ï¼š

```python
def _read(self):
    try:
        # Should be ready to read
        data = self.sock.recv(4096)
    except BlockingIOError:
        # Resource temporarily unavailable (errno EWOULDBLOCK)
        pass
    else:
        if data:
            self._recv_buffer += data
        else:
            raise RuntimeError('Peer closed.')
```

æ³¨æ„ except è¡Œï¼š`except BlockingIOError`ï¼š

`_write()` æ–¹æ³•ä¹Ÿæœ‰ï¼Œè¿™å‡ è¡Œå¾ˆé‡è¦æ˜¯å› ä¸ºå®ƒä»¬æ•è·ä¸´æ—¶é”™è¯¯å¹¶é€šè¿‡ä½¿ç”¨ `pass` è·³è¿‡ã€‚ä¸´æ—¶é”™è¯¯æ˜¯ socket é˜»å¡çš„æ—¶å€™å‘ç”Ÿçš„ï¼Œæ¯”å¦‚ç­‰å¾…ç½‘ç»œå“åº”æˆ–è€…è¿æ¥çš„å…¶å®ƒç«¯

é€šè¿‡ä½¿ç”¨ `pass` è·³è¿‡å¼‚å¸¸ï¼Œ`select()` æ–¹æ³•å°†å†æ¬¡è°ƒç”¨ï¼Œæˆ‘ä»¬å°†æœ‰æœºä¼šé‡æ–°è¯»å†™æ•°æ®

## è¿è¡Œå®¢æˆ·ç«¯/æœåŠ¡å™¨åº”ç”¨ç¨‹åº

ç»è¿‡æ‰€æœ‰è¿™äº›è‰°è‹¦çš„å·¥ä½œåï¼Œè®©æˆ‘ä»¬æŠŠç¨‹åºè¿è¡Œèµ·æ¥å¹¶æ‰¾åˆ°ä¸€äº›ä¹è¶£ï¼

åœ¨è¿™ä¸ªæ•‘å‘½ä¸­ï¼Œæˆ‘ä»¬å°†ä¼ ä¸€ä¸ªç©ºçš„å­—ç¬¦ä¸²åšä¸º `host` å‚æ•°çš„å€¼ï¼Œç”¨æ¥ç›‘å¬æœåŠ¡å™¨ç«¯çš„æ‰€æœ‰IP åœ°å€ã€‚è¿™æ ·çš„è¯æˆ‘å°±å¯ä»¥ä»å…¶å®ƒç½‘ç»œä¸Šçš„è™šæ‹Ÿæœºè¿è¡Œå®¢æˆ·ç«¯ç¨‹åºï¼Œæˆ‘å°†æ¨¡æ‹Ÿä¸€ä¸ª PowerPC çš„æœºå™¨

é¦–å…ˆï¼ŒæŠŠæœåŠ¡ç«¯ç¨‹åºè¿è¡Œè¿›æ¥ï¼š

```python
$ ./app-server.py '' 65432
listening on ('', 65432)
```

ç°åœ¨è®©æˆ‘ä»¬è¿è¡Œå®¢æˆ·ç«¯ï¼Œä¼ å…¥æœç´¢å†…å®¹ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½çœ‹ä»–ï¼ˆå¢¨è²æ–¯-é»‘å®¢å¸å›½ä¸­çš„è§’è‰²ï¼‰ï¼š

```python
$ ./app-client.py 10.0.1.1 65432 search morpheus
starting connection to ('10.0.1.1', 65432)
sending b'\x00d{"byteorder": "big", "content-type": "text/json", "content-encoding": "utf-8", "content-length": 41}{"action": "search", "value": "morpheus"}' to ('10.0.1.1', 65432)
received response {'result': 'Follow the white rabbit. ğŸ°'} from ('10.0.1.1', 65432)
got result: Follow the white rabbit. ğŸ°
closing connection to ('10.0.1.1', 65432)
```

æˆ‘çš„å‘½ä»¤è¡Œ shell ä½¿ç”¨äº† utf-8 ç¼–ç ï¼Œæ‰€ä»¥ä¸Šé¢çš„è¾“å‡ºå¯ä»¥æ˜¯ emojis

å†è¯•è¯•çœ‹èƒ½ä¸èƒ½æœç´¢åˆ°å°ç‹—ï¼š

```python
$ ./app-client.py 10.0.1.1 65432 search ğŸ¶
starting connection to ('10.0.1.1', 65432)
sending b'\x00d{"byteorder": "big", "content-type": "text/json", "content-encoding": "utf-8", "content-length": 37}{"action": "search", "value": "\xf0\x9f\x90\xb6"}' to ('10.0.1.1', 65432)
received response {'result': 'ğŸ¾ Playing ball! ğŸ'} from ('10.0.1.1', 65432)
got result: ğŸ¾ Playing ball! ğŸ
closing connection to ('10.0.1.1', 65432)
```

æ³¨æ„è¯·æ±‚å‘é€è¡Œçš„ byte stringï¼Œå¾ˆå®¹æ˜“çœ‹å‡ºæ¥ä½ å‘é€çš„å°ç‹— emoji è¡¨æƒ…è¢«æ‰“å°æˆäº†åå…­è¿›åˆ¶çš„å­—ç¬¦ä¸² `\xf0\x9f\x90\xb6`ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨ emoji è¡¨æƒ…æ¥æœç´¢æ˜¯å› ä¸ºæˆ‘çš„å‘½ä»¤è¡Œæ”¯æŒutf-8 æ ¼å¼çš„ç¼–ç 

è¿™ä¸ªç¤ºä¾‹ä¸­æˆ‘ä»¬å‘é€ç»™ç½‘ç»œåŸå§‹çš„ bytesï¼Œè¿™äº› bytes éœ€è¦è¢«æ¥å—è€…æ­£ç¡®çš„è§£é‡Šã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¹‹å‰éœ€è¦ç»™æ¶ˆæ¯é™„åŠ å¤´ä¿¡æ¯å¹¶ä¸”åŒ…å«ç¼–ç ç±»å‹å­—æ®µçš„åŸå› 

ä¸‹é¢è¿™ä¸ªæ˜¯æœåŠ¡å™¨å¯¹åº”ä¸Šé¢ä¸¤ä¸ªå®¢æˆ·ç«¯è¿æ¥çš„è¾“å‡ºï¼š

```bash
accepted connection from ('10.0.2.2', 55340)
received request {'action': 'search', 'value': 'morpheus'} from ('10.0.2.2', 55340)
sending b'\x00g{"byteorder": "little", "content-type": "text/json", "content-encoding": "utf-8", "content-length": 43}{"result": "Follow the white rabbit. \xf0\x9f\x90\xb0"}' to ('10.0.2.2', 55340)
closing connection to ('10.0.2.2', 55340)

accepted connection from ('10.0.2.2', 55338)
received request {'action': 'search', 'value': 'ğŸ¶'} from ('10.0.2.2', 55338)
sending b'\x00g{"byteorder": "little", "content-type": "text/json", "content-encoding": "utf-8", "content-length": 37}{"result": "\xf0\x9f\x90\xbe Playing ball! \xf0\x9f\x8f\x90"}' to ('10.0.2.2', 55338)
closing connection to ('10.0.2.2', 55338)
```

æ³¨æ„å‘é€è¡Œä¸­å†™åˆ°å®¢æˆ·ç«¯çš„ bytesï¼Œè¿™å°±æ˜¯æœåŠ¡ç«¯çš„å“åº”æ¶ˆæ¯

å¦‚æœ action å‚æ•°ä¸æ˜¯æœç´¢ï¼Œä½ ä¹Ÿå¯ä»¥è¯•è¯•ç»™æœåŠ¡å™¨å‘é€äºŒè¿›åˆ¶è¯·æ±‚

```bash
$ ./app-client.py 10.0.1.1 65432 binary ğŸ˜ƒ
starting connection to ('10.0.1.1', 65432)
sending b'\x00|{"byteorder": "big", "content-type": "binary/custom-client-binary-type", "content-encoding": "binary", "content-length": 10}binary\xf0\x9f\x98\x83' to ('10.0.1.1', 65432)
received binary/custom-server-binary-type response from ('10.0.1.1', 65432)
got response: b'First 10 bytes of request: binary\xf0\x9f\x98\x83'
closing connection to ('10.0.1.1', 65432)
```

ç”±äºè¯·æ±‚çš„ content-type ä¸æ˜¯ `text/json`ï¼ŒæœåŠ¡å™¨ä¼šæŠŠå†…å®¹å½“æˆäºŒè¿›åˆ¶ç±»å‹å¹¶ä¸”ä¸ä¼šè§£ç  JSONï¼Œå®ƒåªä¼šæ‰“å° content-type å’Œè¿”å›çš„å‰ 10 ä¸ª bytes ç»™å®¢æˆ·ç«¯

```bash
$ ./app-server.py '' 65432
listening on ('', 65432)
accepted connection from ('10.0.2.2', 55320)
received binary/custom-client-binary-type request from ('10.0.2.2', 55320)
sending b'\x00\x7f{"byteorder": "little", "content-type": "binary/custom-server-binary-type", "content-encoding": "binary", "content-length": 37}First 10 bytes of request: binary\xf0\x9f\x98\x83' to ('10.0.2.2', 55320)
closing connection to ('10.0.2.2', 55320)
```

